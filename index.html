<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>Getting MEAN with Ansible</title>

	<meta name="description" content="Getting MEAN with Ansible">
	<meta name="author" content="Ross Kukulinski">

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<link rel="stylesheet" href="slides/css/reveal.min.css">
	<link rel="stylesheet" href="slides/css/theme/default.css" id="theme">

	<!-- For syntax highlighting -->
	<link rel="stylesheet" href="slides/lib/css/zenburn.css">

	<!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->
</head>

<body>

	<div class="reveal">

		<!-- Any section element inside of this container is displayed as a slide -->
		<div class="slides">
			<section>
				<h2>Getting MEAN with Ansible</h2>
				<h2>and Digital Ocean</h2>
				<p>
				<a href="http://twitter.com/rosskukulinski">@RossKukulinski</a><br>
				<a href='http://speakit.io'>SpeakIt.io Co-Founder</a><br>
				<a href='http://www.meetup.com/BayNode/'>BayNode Meetup</a>
				</p>
			</section>

			<section>
				<h2>Warmup: Raise your hand if...</h2>
				<ul>
					<li class="fragment">This is your first time learning about Ansible</li>
					<li class="fragment">You have tried Ansible</li>
					<li class="fragment">You have used Ansible in production</li>
					<li class="fragment">You could be up here talking about Ansible</li>
				</ul>
			</section>

			<section>
				<h2>Warmup 2: Raise your hand if...</h2>
				<ul>
					<li class="fragment">You've never heard of MEAN <br>
						(hint: MongoDB, ExpressJS, AngularJS, NodeJS)</li>
					<li class="fragment">You have used NodeJS</li>
					<li class="fragment">You have used Ansible to deploy NodeJS or MongoDB</li>
				</ul>
			</section>

			<section>
				<h1>Ansible</h1>
				<h2>is awesome</h2>
			</section>

			<section>
				<p><b>Ansible</b> is an open-source software platform for configuring and managing computers
				</p>
				<br/>
				<h3>Orchestration Engine</h3>
			</section>

			<section>
				<h1>Quick Ansible Tutorial</h1>
			</section>

			<section>
				<h2>Plays (and Roles)</h2>
				<pre><code data-trim style="font-size: 16px">
- name: Add nginx apt repo
  apt_repository: repo='ppa:chris-lea/nginx-devel' state=present update_cache=yes

- name: Install the nginx packages
  apt: name=nginx state=present update_cache=yes
  notify: restart nginx

- name: Copy the nginx sites file
  template: src=default.j2 dest=/etc/nginx/sites-available/default
  notify: reload nginx

- include: iptables.yml
				</code></pre>
			</section>

			<section>
				<h2>Playbooks</h2>
				<pre><code data-trim>
- name: configure and deploy nginx load balancer
  hosts: nginx-prod
  user: root

  roles:
  - common
  - nginx

- name: configure and deploy nodejs app
  hosts: app-prod
  user: root

  roles:
  - common
  - nodejs-app
				</code></pre>
			</section>

			<section>
				<h2>Inventory</h2>
		    <pre><code data-trim>
[app-prod]
162.1.2.3
162.1.2.4

[nginx-prod]
162.2.1.3
		    </code></pre>
			</section>

			<section>
				<h1>Ok, onto 'real' stuff</h1>
			</section>

			<section>
				<h2>Let's create VMs on Digitial Ocean</h2>
				provision_digital_ocean.yml
<pre><code data-trim>
---
- hosts: localhost
  gather_facts: False

  vars_files:
    - vars/keys.yml
    - vars/droplets.yml

  tasks:
    - include: tasks/create_droplet.yml droplets={{droplets}}

</code></pre>
</section>

<section>
	<h2>droplets.yml</h2>
	<pre><code data-trim>
---
droplets:
  - name: production.nginx.1
  - name: production.app.1
  - name: production.mongodb.1

</code></pre>
</section>

			<section>
				<h2>create_droplet.yml</h2>
				<pre><code data-trim>
---
- name: ensure droplet exists
  digital_ocean: >
    state=present
    command=droplet
    name={{ item.name }}
    ssh_key_ids={{ default_key }}
    size_id={{ item.size|default(default_size) }}
    region_id={{ item.region|default(default_region) }}
    image_id={{ item.image|default(default_image) }}
    private_networking=yes
    wait_timeout=500
    unique_name=true
  register: droplet
  with_items: droplets
</code></pre>
			</section>

			<section>
				<h2>Digital Ocean</h2>
				<img src="slides/img/do_droplets.png">
			</section>


			<section>
				<h1>Dynamic Inventory!</h1>
				<img src="slides/img/hosts.png" width=500><br>
<pre><code data-trim>
ansible-playbook -i hosts site.yml
</code></pre>
			</section>


<section>
	<h2>This becomes our Inventory</h2>
	<img src="slides/img/do_droplets.png">
</section>

<section>
	<h2>Putting it all together</h2>
</section>

			<section>
				<h2>site.yml (1/3)</h2>
				<pre><code data-trim>
- include: provision_digital_ocean.yml
#  MongoDB Configuration
- hosts: production.mongodb.*
  user: root
  vars_files:
    - vars/database.yml
  tasks:
    - name: Add production.mongodb.* to inventory
      group_by: key="production.mongodb"
    - name: setfact
      set_fact: db_ip={{ ansible_eth1["ipv4"]["address"] }}
  roles:
    - common
    - mongodb

</code></pre>
</section>


			<section>
				<h2>site.yml (2/3)</h2>
				<pre><code data-trim>
#  NodeJS Todo App Configuration
- hosts: production.app.*
  user: root
  vars_files:
    - vars/database.yml
  tasks:
    - name: Add production.app.* to inventory
      group_by: key="production.app"
    - name: setfact
      set_fact: http_ip={{ ansible_eth1["ipv4"]["address"] }}
  roles:
    - common
    - nodejs
    - app
</code></pre>
</section>

<section>
	<h2>NodeJS DB Connection</h2>
	<pre><code data-trim>
module.exports = {
  // the database url to connect
  url : 'mongodb://
    {%- for host in groups['production.mongodb'] -%}
      {{ hostvars[host]['db_ip'] }}
        {%- if loop.first -%}
          /{{db_name}}
        {% endif %}
        {%- if loop.length > 1 and not loop.last -%}
          ,
        {% endif %}
    {% endfor %}';
}
// url : 'mongodb://10.128.190.31/node-todo,10.128.190.11,10.112.232.11'
</code></pre>
</section>

<section>
	<h2>site.yml (3/3)</h2>
	<pre><code data-trim>
#  Nginx Configuration
- hosts: production.nginx.*
  user: root
  tasks:
    - name: Add production.nginx.* to inventory
      group_by: key="production.nginx"
  roles:
    - common
    - nginx
</code></pre>
</section>

<section>
	<h2>nginx site</h2>
	<pre><code data-trim>
# Simple Load Balancer
upstream static  {
  least_conn;
  {% for host in groups['production.app'] %}
    server {{ hostvars[host]['http_ip'] }}:8080;
  {% endfor %}
}
server {
  listen 80;
  location / {
    proxy_pass http://static/;
    proxy_http_version 1.1;
    proxy_next_upstream error timeout;
  }
}
	</code></pre>
</section>

<section>
	<h2>Demo!</h2>
	<a href="http://107.170.97.37" target="_blank">http://107.170.97.37</a>
</section>

			<section>
				<h2>References</h2>
					<a href="https://github.com/garethr/ansible-provisioner">https://github.com/garethr/ansible-provisioner</a><br>
					<a href="https://github.com/scotch-io/node-todo/tree/tut1-starter">https://github.com/scotch-io/node-todo/tree/tut1-starter</a><br>
					<a href="https://github.com/rosskukulinski/getting-mean-with-ansible">https://github.com/rosskukulinski/getting-mean-with-ansible</a>
					<p>
						Special thanks to <a href="https://twitter.com/jareddlc">@jareddlc</a>
					</p>
			</section>

			<section>
					<h1>Thanks!</h1>
					<a href="http://kukulinski.com">Ross Kukulinski</a><br>
					<a href="http://twitter.com/rosskukulinski">@rosskukulinski</a><br>
					<a href='http://speakit.io'>ross _at_ SpeakIt.io</a>

			</section>


		</div>

		<script src="slides/lib/js/head.min.js"></script>
		<script src="slides/js/reveal.min.js"></script>

		<script>

		// Full list of configuration options available here:
		// https://github.com/hakimel/reveal.js#configuration
		Reveal.initialize({
			controls: false,
			progress: false,
			history: true,
			center: true,
			slideNumber: true,

			theme: 'beige', // available themes are in /css/theme
			transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

			// Optional libraries used to extend on reveal.js
			dependencies: [
			{ src: 'slides/lib/js/classList.js', condition: function() { return !document.body.classList; } },
			{ src: 'slides/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
			{ src: 'slides/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
			]
		});

		</script>

	</body>
	</html>
